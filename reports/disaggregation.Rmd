---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: false
    fig_caption: true
    latex_engine: pdflatex
title: Borrowing information across spatial scales 
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
abstract: 
keywords: 
date: "Y"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  pow_dist : 1
  from : KONO
  n.sim : 1000
  n.dates.sim : 49
  p.stay: 0.9
  ADM0: SIERRALEONE
---

```{r global_options, include=FALSE}

knitr::opts_chunk$set(
  fig.width = 12, fig.height = 6,
  echo = FALSE,
  warning = FALSE, message = FALSE,
  fig.path = "figures/"
)
```

```{r setup, eval = TRUE}

library(dplyr)
library(magrittr)
library(stringr)
library(ggplot2)
library(purrr)
library(EpiEstim)
devtools::load_all()
```

## Unpack parameters

```{r pars_read, eval = TRUE}

pow_dist <- params$pow_dist
t.proj <- params$t.proj
n.sim <- params$n.sim
n.dates.sim <- params$n.dates.sim
p.stay <- params$p.stay
adm0 <- params$ADM0
from <- params$from
method <- list("pop_density" = TRUE, "2" = FALSE, "3" = FALSE)

```

## Model

We will assign the national case count to districts according to a
multinomial distribution with the probabilities derived from gravity
model or simply population density. 

First we read in the data that is required by both methods.

## Districts meta-data

```{r districts_coord, eval = TRUE}

centroids <- here::here(
  "data/Geography/GravityModel/processed",
  "all_centroids.csv"
) %>%
  readr::read_csv(.) %>%
  filter(ADM0 == adm0)
```

## Incidence data from HealthMap

```{r hm_data, eval = TRUE}

hm_wide <- here::here(
  "data/CaseCounts/processed",
  "HealthMap_Ebola_wide.csv"
) %>%
  readr::read_csv(.)
```  

We will work with weekly incidence counts. 

```{r hm_weekly, eval = TRUE}

hm_weekly <- daily.to.weekly(hm_wide)
```

## Incidence data from WHO

District-level data from WHO to compare our estimates with.


```{r who, eval = TRUE}
cols <- c("Date", centroids$CL_DistrictRes)
who_districts <- here::here(
  "data/CaseCounts/processed",
  "WHO_wide.csv"
) %>%
  readr::read_csv(.) %>%
  select(cols)


who_weekly <- daily.to.weekly(who_districts) %>%
  tidyr::gather(district, incid, -Date)

who_weekly$Date <- as.Date(who_weekly$Date)
```

## Method 1: Relative population density

Take the weekly incidence
count and distribute it to the districts in proportion to their
relative density.

```{r pop_density, eval = method[["pop_density"]]}

pop_density <- data.frame(
  district = centroids$CL_DistrictRes,
  rel_density = centroids$pop / sum(centroids$pop)
)
prob <- pop_density$rel_density
```

## Method 2: Relative risk based on gravity model


```{r pmovement, eval = method[["2"]]}
flow_mat <- flow_matrix(
  longitude = centroids$lon,
  latitude = centroids$lat,
  population = centroids$pop,
  place_names = centroids$CL_DistrictRes,
  model = "gravity", K = K,
  pow_N_from = pow_N_from,
  pow_N_to = pow_N_to,
  pow_dist = pow_dist
)
rel_risk <- flow_mat / rowSums(flow_mat, na.rm = TRUE)
p_movement <- probability_movement(rel_risk, p_stay)
prob <- p_movement[from, ]
```
## Method 3: Relative to the reproduction number from recent past

Suppose we are doing the disaggregation in the last week of 2014.
Read in the latest information published by WHO.

```{r}
who_bydistrict <- here::here("data/CaseCounts/processed",
                             "processed_who_sl_2014-12-17.csv") %>%
    read.csv(.)
weeks <- stringr::str_pad(1:50, 2, pad = "0")
weeks_of_2014 <- paste0("2014-W", weeks)
who_bydistrict$week_of_year <- factor(who_bydistrict$week_of_year,
                                      levels = weeks_of_2014)

who_bydistrict <- arrange(who_bydistrict, week_of_year)

```

Look at the data.

```{r}
p <- ggplot(who_bydistrict, aes(week_of_year,
                                new_cases,
                                col = data_source))
p <- p + geom_point()
p <- p + facet_wrap(~location)
p <- p + theme_bw()
p
```

We will use data from Situation Report and add confirmed and probable 
cases. Treat NAs as 0.

```{r}
who_sitrep <- filter(who_bydistrict,
                     data_source == "situationreport") %>%
    droplevels()

who_sitrep <- group_by(who_sitrep, location, week_of_year) %>%
    summarise(total = sum(new_cases)) 
##    filter(as.integer(week_of_year) > 37)

who_wide <- tidyr::spread(who_sitrep, location, total, fill = 0)
```

```{r ebola_params}

mean_SI     <- 14.2
CV_SI       <- 9.6 / 14.2
SItrunc     <- 40
SI_Distr    <- sapply(0:SItrunc, function(e) DiscrSI(e, mean_SI, mean_SI * CV_SI))
SI_Distr    <- SI_Distr / sum(SI_Distr)


```

```{r}
r.estim   <- select_if(who_wide, is.numeric)  %>%
    map(function(x) {
        df = data.frame(t = seq_len(length(x)), incid = x)
        glm(x ~ t, data = df, family = poisson())
    })

## check fit
predicted <- map(r.estim, predict, type = "response") %>%
    dplyr::bind_cols(.)

predicted$week_of_year <- who_wide$week_of_year

list(predicted = predicted, observed = who_wide) %>%
    dplyr::bind_rows(.id = "data_source") %>%
    tidyr::gather(district, incid, -week_of_year, -data_source) %>%
    ggplot(aes(week_of_year, incid, col = data_source)) + geom_point() +
    facet_wrap(~district, scale = "free_y")



```

Extract the coefficients from the fits.
```{r}
district_rates <- map_dfc(r.estim, function(x) coef(x)["t"])
```
## Assign cases to districts

Best to do it when the number of cases is not too small.

```{r assign, eval = TRUE}

hm_large <- filter(hm_weekly, `Sierra Leone` > 2)
sl_large <- select(hm_large, c(Date, `Sierra Leone`))
district_weekly <- split(sl_large, sl_large$Date) %>%
  lapply(function(df) {
    mat <- disaggregate(
      total = df$`Sierra Leone`,
      prob = prob
    )
    distr <- t(apply(
      mat, 1, quantile,
      probs = c(0.025, 0.5, 0.975)
    ))
    rownames(distr) <- pop_density$district
    distr <- data.frame(distr)
    distr <- tibble::rownames_to_column(distr, var = "district")
    distr
  }) %>% bind_rows(.id = "Date")
district_weekly$Date <- as.Date(district_weekly$Date)
```


## Compare with data from WHO

Put them together and plot.

```{r compare, eval = TRUE}
who_weekly$Date <- as.Date(who_weekly$Date)

comparison <- left_join(who_weekly, district_weekly) %>% na.omit()
comparison$Date <- as.Date(comparison$Date)

p <- ggplot(comparison, aes(Date,incid)) + geom_point(size = 0.5,
                                                      col = "blue") 
p <- p + facet_wrap(~district, scales = "free_y")
p <- p + geom_line(aes(y = `X50.`))
p <- p + geom_ribbon(aes(ymin = `X2.5.`,
                         ymax = `X97.5.`,
                         group = 1), alpha = 0.5)
p <- p + theme_classic()
p
here::here("output", paste0(from,"_", pow_dist, ".png")) %>%
    ggsave(p)
```

