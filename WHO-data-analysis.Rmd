---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
title: Analysis of Ebola data from WHO
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
date: "`r format(Sys.time(), '%d %B, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
bibliography: 
biblio-style: apsr
endnote: no
---
```{r, echo = FALSE}
library(magrittr)
library(ggplot2)
library(dplyr)
library(EpiEstim)
devtools::load_all()
```
# Data clean-up
Epidemiological case definition of probable and suspected cases
differed across countries while confirmed cases were the ones
confirmed through lab report. For the purpose of the current analysis,
one approach could be to lump them together. The inferred date of
onset (rather than the date reported) is used for estimation.


```{r}
who_raw <- read.csv("data/CaseCounts/who/rstb20160308supp1.csv")
who_raw$DateOnsetInferred %<>% as.Date
```

For each district in a country, add the number of records for each date to get
incidence count.
```{r}
who_incidence <- who_raw %>% 
                  dplyr::group_by(Country, DateOnsetInferred, CL_DistrictRes) %>% 
                  dplyr::summarise(count = n())

ggplot(who_incidence, aes(DateOnsetInferred, count)) +
    geom_point() +
    facet_grid(Country~.) +
    xlab("Date of onset") + theme_minimal()
```

# Comparison with the data from Health Map.

First read in and clean up the data from Health Map. Since these data
are at national level, we will also aggregate the WHO data at country
level. HealthMap collects and curates data on the cumulative number
of cases (C) and deaths (D) stratified by status (suspected, SC/SD, or
confirmed CC/CD). For data from the WHO, the case status could be
confirmed, probable or suspected. The final clinical outcome (alive/dead)
for each case is also recorded. In comparing the two data sets, we sum
across all four categories in Healthmap and derive incidence data from
cumulative data.

```{r, echo = FALSE}
species   <- "Humans"
disease   <- "Ebola"
case.type <- "SCC"
healthmap <- "data/CaseCounts/raw/HealthMap_Ebola_GNE_WHO.csv" %>%
               read.csv(stringsAsFactors = FALSE) %>%
               dplyr::filter(species == species,
                             disease == disease,
                             case.type == case.type,
                             Country %in% unique(who_incidence$Country) )

healthmap_bycountry <- split(healthmap, healthmap$Country) 

healthmap_weekly    <- healthmap_bycountry %>%
                       lapply(function(case.count){
                               location <- case.count$Country[1]
                               case.count %<>%
                                  incidence.from.DS1(species, disease,
                                                   case.type,
                                                   location,
                                                   merge_rule = "median") %<>%
                                 daily.to.weekly }) %>%
                        dplyr::bind_rows(.id = "Country")

who_country <- who_incidence %>%
                  dplyr::group_by(Country, DateOnsetInferred) %>% 
                  dplyr::summarise(count = n()) %>%
                  dplyr::rename(incid = count, Date = DateOnsetInferred) 


who_weekly <- split(who_country, who_country$Country) %>%
              lapply(function(df){
                      df      %>%
                      ungroup %>%
                      select(Date, incid) %>%
                      daily.to.weekly}) %>%
                dplyr::bind_rows(.id = "Country")    
who_weekly$Date       %<>% as.Date
healthmap_weekly$Date %<>% as.Date
list( WHO = who_weekly,
      HealthMap = healthmap_weekly[, c("Country", "Date", "incid")]) %>%
    dplyr::bind_rows(.id = "Source") %>%
    ggplot(aes(Date, incid, color = Source)) +
    geom_point() +
    facet_grid(Country ~.) +
    scale_x_date(date_labels="%d-%m-%y",date_breaks = "2 weeks") +
    theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

HealthMap numbers (after data clean-up) appear to be much bigger than
the numbers from WHO, particularly in the middle of the
epidemic. 


# Estimating Reproduction number from WHO and Healthmap Data

```{r}
mean_SI     <- 14.2
CV_SI       <- 9.6 / 14.2
SItrunc     <- 40
SI_Distr    <- sapply(0:SItrunc, function(e) DiscrSI(e, mean_SI, mean_SI * CV_SI))
SI_Distr    <- SI_Distr / sum(SI_Distr)
time_window <- 7 * 7
healthmap_R <- healthmap_bycountry %>%
               lapply(function(case.count){
                        location <- case.count$Country[1]
                        case.count %<>%
                        incidence.from.DS1(species, disease,
                                           case.type,
                                           location,
                                           merge_rule = "median")
                        start     <- 1:(length(case.count$Date) - time_window)
                        end       <- start + time_window
                        end.dates <- case.count$Date[end] 
                        res       <- EstimateR(case.count$incid,
                                               T.Start  = start ,
                                               T.End    = end,
                                               method   = "NonParametricSI",
                                               SI.Distr = SI_Distr,
                                               plot     = FALSE ,
                                               CV.Posterior = 1 ,
                                               Mean.Prior   = 1 ,
                                               Std.Prior    = 0.5)
                        res$R %<>% cbind(Date = end.dates)
                        return(res$R)}) %>%
              bind_rows(.id = "Country")

WHO_R <- who_country      %>%
         split(.$Country) %>%
         lapply(function(case.count){
                  location  <- case.count$Country[1]
                  start     <- 1:(length(case.count$Date) - time_window)
                  end       <- start + time_window
                  end.dates <- case.count$Date[end] 
                  res       <- EstimateR(case.count$incid,
                                         T.Start  = start ,
                                         T.End    = end,
                                         method   = "NonParametricSI",
                                         SI.Distr = SI_Distr,
                                         plot     = FALSE ,
                                         CV.Posterior = 1 ,
                                         Mean.Prior   = 1 ,
                                         Std.Prior    = 0.5)
                  res$R %<>% cbind(Date = end.dates)
                  return(res$R)}) %>%
           bind_rows(.id = "Country")


list( WHO = WHO_R, HealthMap = healthmap_R) %>%
    dplyr::bind_rows(.id = "Source") %>%
    ggplot(aes(Date, `Mean(R)`, color = Source)) +
    geom_line() +
    facet_grid(Country ~.) +
    scale_x_date(date_labels="%d-%m-%y",date_breaks = "2 weeks") +
    theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
