---
output: html_document
title: Analysis of WHO Ebola data
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
abstract: 
keywords: 
date: "Y"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  pow_dist : 1.2
  t.proj : 250
  n.sim : 1000
  n.dates.sim : 35
  p.stay: 0.9
  
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE)
```

```{r setup, echo = FALSE}
library(magrittr)
library(ggplot2)
library(dplyr)
library(EpiEstim)
devtools::load_all()

pow_dist    <- params$pow_dist
t.proj      <- params$t.proj
n.sim       <- params$n.sim
n.dates.sim <- params$n.dates.sim
p.stay      <- params$p.stay


```
# Data clean-up
The current data set has three possible values for the epidemiological
case definition - confirmed, probable and suspected.
Epidemiological case definition of probable and suspected cases
differed across countries while confirmed cases were the ones
confirmed through lab report. For the purpose of the current analysis,
one approach could be to lump all of them together. The inferred date of
onset (rather than the date reported) is used for estimation.
The columns we use are : Country, EpiCaseDef (probably),
DateOnsetInferred and CL_DistrictRes. 


```{r rawdata}
WHO_raw <- read.csv("data/CaseCounts/who/rstb20160308supp1.csv",
                    colClasses = c(Country = "factor",
                                   EpiCaseDef = "character",
                                   DateOnsetInferred = "Date",
                                   CL_DistrictRes = "factor")) %>%
           select(Country, EpiCaseDef,
                  DateOnsetInferred,CL_DistrictRes) %>%
           na.omit

WHO_raw$CL_DistrictRes %<>% gsub(' ', '', .)  %<>% factor



```


## Grouping by districts and interpolating missing data
For each district in a country, add the number of records for each
date to get incidence count.

```{r bydistricts}

WHO_bydistricts <- WHO_raw %>% 
                   group_by(Country, CL_DistrictRes,
                                   DateOnsetInferred) %>%
                   summarise(incid = n())

```

Within each district, if there is a date on which no cases are
recorded, we assume that there were no cases on that date and add this
to the record. At the end of this step, the incidence time series for
each district should be a daily time series.

```{r fillup}

WHO_bydistricts %<>%
    split(.$CL_DistrictRes) %<>%
    lapply(add_0incid) %<>%
    bind_rows


WHO_bydistricts %<>% rename(Date = DateOnsetInferred)

```

```{r raw_viz, eval = FALSE}
WHO_bycountry <- WHO_bydistricts %>%
                  group_by(Country,Date) %>%
                  summarise(incid = sum(incid)) 


ggplot(WHO_bydistricts, aes(Date, incid)) +
    geom_point() +
    facet_wrap(~CL_DistrictRes) +
    theme_minimal() +
    ggtitle("Incidence in each district") +
    xlab("") + theme(axis.text.x = element_text(angle = 45, vjust = 0.2))

ggplot(WHO_bycountry, aes(Date, incid)) +
    geom_point() +
    facet_wrap(~Country) +
    theme_minimal() +
    ggtitle("Incidence in each country") +
    xlab("") + theme(axis.text.x = element_text(angle = 45, vjust = 0.2))

```

# Parameters for Ebola

Culled from literature.

```{r ebola_params}
mean_SI     <- 14.2
CV_SI       <- 9.6 / 14.2
SItrunc     <- 40
SI_Distr    <- sapply(0:SItrunc, function(e) DiscrSI(e, mean_SI, mean_SI * CV_SI))
SI_Distr    <- SI_Distr / sum(SI_Distr)
time_window <- 7 * 7
```

# Gravity model parameters

```{r gm_params}

pow_N_to <- pow_N_from <- 1
K        <- 1

```

# Comparison with the data from Health Map

```{r child = 'WHO-data-analysis-HM-comparison.Rmd', eval = FALSE}
```

# Projection using WHO data

## Projection within Sierra Leone

```{r child = 'WHO-data-analysis-Sierra.Rmd'}
```

## Projection within Liberia

```{r child = 'WHO-data-analysis-Liberia.Rmd'}
```

## Projection within Guinea

```{r child = 'WHO-data-analysis-Guinea.Rmd'}
```

## Projection across all districts within Sierra Leone, Liberia and Guinea

```{r child = 'WHO-data-analysis-alldistricts.Rmd'}
```

## Evaluating goodness of fit
```{r}
outfile    <- "output/alldistricts-rms-0811.csv"
residuals  <- read.csv(outfile)
normalise  <- function(col) col/norm(col, "2") 
normalised <- select(residuals, -c(pow_dist, p.stay)) %>%
              apply(2, normalise) %>% rowSums

pstay <- unique(residuals$p.stay)   %>% sort
power <- unique(residuals$pow_dist) %>% sort
rms   <- matrix(normalised, nrow = length(power), byrow = TRUE)
plotly::plot_ly(x = ~power, y = ~pstay, z = ~rms) %>% add_surface()

```
