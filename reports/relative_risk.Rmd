---
output: 
pdf_document:
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: Estimate relative risk profile
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  from : Ã©quateur
  alpha : 2.01
  rho : 1.30
  tau : 1.12
---

```{r setup, eval = TRUE}
library(dplyr)
library(stringr)
library(ggplot2)
devtools::load_all()
```

## Workflow

1. Compute the flow matrix using the parameters of the gravity model.
2. Compute the relative risk matrix using $p_{stay}$.
3. Extract the top 10 places most at risk from a given location
   (input).

```{r}
centroids <- outfile <- here::here("data/Geography/GravityModel/processed",
                                   "drc_neighbors_area.csv") %>%
    readr::read_csv()


centroids <- mutate(centroids, district_clean = clean_names(district))

```


## Flow Matrix 
```{r flowmat, eval = TRUE}



flow_from_to <- flow_matrix(
  longitude = centroids$Centroid_Lon,
  latitude = centroids$Centroid_Lat,
  population = centroids$Pop,
  place_names = centroids$district_clean,
  model = "gravity",
  K = params$K,
  pow_N_from = params$pow_N_from,
  pow_N_to = params$pow_N_to,
  pow_dist = params$pow_dist
)


## Relative Flow

```

Probability that 1 person from params$from will move to j.
Note that there is no reason why flow from i to j should be smaller
than the population at i. Hence the "probability" here can be greater
than 1.

```{r absrisk, eval = FALSE}

source_pop <- filter(centroids, district_clean == params$from) %>%
    pull(Pop)
pij <- flow_from_to[params$from, ] / source_pop
abs_risk_df <- tibble::rownames_to_column(data.frame(pij),
                                          var = "flow_to" )
abs_risk_df$flow_from <- params$from
from_source <- left_join(abs_risk_df,
                         centroids,
                         by = c("flow_to" = "district_clean")) %>%
    select(flow_from, flow_to, district, ADM0, pij)
outfile_prefix <- "pmovement_from_"


```

Write it out in a clean format. The rownames will be the cleaned
district names.

```{r relrisk, eval = TRUE}
relative_risk <- flow_from_to / rowSums(flow_from_to, na.rm = TRUE)
rel_risk_df <- tibble::rownames_to_column(data.frame(relative_risk),
                                            var = "flow_from")
from_source <- filter(rel_risk_df,
                      flow_from == params$from) %>%
    tidyr::gather(flow_to, relative_flow, -flow_from) 

from_source <- left_join(from_source,
                         centroids,
                         by = c("flow_to" = "district_clean")) %>%
    select(flow_from, flow_to, district, ADM0, relative_flow)
outfile_prefix <- "flow_from_"
##    top_n(10)
##from_source$relative_flow <- round(from_source$relative_flow, 3)
```

```{r write, eval = TRUE}
idx <- which(from_source$flow_to == "louvakou.loubomo.")
from_source$flow_to[idx] <- "louvakou(loubomo)"

outfile_suffix <- paste(sapply(params, paste, collapse=""),
                        collapse = "_")
here::here("output",
           paste0(outfile_prefix, outfile_suffix, ".csv")) %>%
    readr::write_csv(x = from_source,
                     path = .)
```



