---
output: 
pdf_document:
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: Estimate relative risk profile
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  pow_dist : 2
  K : 1
  pow_N_from : 1
  pow_N_to : 1
  from : Democratic Republic of the Congo
  p_stay: 1
---

```{r setup, eval = TRUE}
library(dplyr)
library(magrittr)
library(stringr)
library(ggplot2)
devtools::load_all()
```

## Workflow

1. Compute the flow matrix using the parameters of the gravity model.
2. Compute the relative risk matrix using $p_{stay}$.
3. Extract the top 10 places most at risk from a given location
   (input).

```{r flowmat, eval = TRUE}
adm0_centroids <- here::here("data/Geography/GravityModel/raw",
                             "adm0_centroids_fixed.tsv") %>%
  readr::read_tsv(col_names = FALSE) 

names(adm0_centroids) <- c("country", "id", "lon", "lat", "pop")

flow_from_to <- flow_matrix(
  longitude = adm0_centroids$lon,
  latitude = adm0_centroids$lat,
  population = adm0_centroids$pop,
  place_names = adm0_centroids$country,
  model = "gravity",
  K = params$K,
  pow_N_from = params$pow_N_from,
  pow_N_to = params$pow_N_to,
  pow_dist = params$pow_dist
)


## Relative Flow
relative_risk <- flow_from_to / rowSums(flow_from_to, na.rm = TRUE)

## matrix characterising the population movement between geographical units
# pmovement <- probability_movement(relative_risk, params$p_stay)

```

Write it out in a clean format.

```{r write, eval = TRUE}
rel_risk_df <- tibble::rownames_to_column(data.frame(relative_risk),
                                            var = "flow_from")
from_source <- filter(rel_risk_df,
                   flow_from == params$from) %>%
    tidyr::gather(flow_to, relative_flow, -flow_from) %>%
    top_n(10)
from_source$relative_flow <- round(from_source$relative_flow, 3)
here::here("output",
           paste0("flow_from_",
                  params$from,
                  "_",
                  params$pow_dist,
                  ".csv")) %>% readr::write_csv(x = from_source,
                                                path = .)
```




