---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
title: Analysis of Ebola data from WHO
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
date: "`r format(Sys.time(), '%d %B, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
bibliography: 
biblio-style: apsr
endnote: no
---
```{r, echo = FALSE}
library(magrittr)
library(ggplot2)
library(dplyr)
library(EpiEstim)
devtools::load_all()
```
# Data clean-up
Epidemiological case definition of probable and suspected cases
differed across countries while confirmed cases were the ones
confirmed through lab report. For the purpose of the current analysis,
one approach could be to lump them together. The inferred date of
onset (rather than the date reported) is used for estimation.


```{r}
WHO_raw <- read.csv("data/CaseCounts/who/rstb20160308supp1.csv")
WHO_raw$DateOnsetInferred %<>% as.Date
```

For each district in a country, add the number of records for each date to get
incidence count.
```{r}
WHO_bydistricts <- WHO_raw %>% 
                   dplyr::group_by(Country,
                                   DateOnsetInferred, CL_DistrictRes) %>%                           dplyr::summarise(count = n())

ggplot(WHO_bydistricts, aes(DateOnsetInferred, count)) +
    geom_point() +
    facet_grid(Country~.) +
    xlab("Date of onset") + theme_minimal()
```

There is some missing data - the incidence time series is not a daily
time series. We will need to interpolate as the R estimation module
expects a daily time series. We do this interpolation at the district
level.

```{r}
WHO_bydistricts           %<>%
  split(.$CL_DistrictRes) %>%
  lapply(function(district){
      district %<>% na.omit
      country <- unique(district$Country)
      dis     <- unique(district$CL_DistrictRes)
      district$Cases <- cumsum(district$count)
      district %<>%
          rename(Date = DateOnsetInferred, incid = count) %<>%
          interpolate.missing.data

      district$Country        <- country
      district$CL_DistrictRes <- dis
      district$incid          <- c(0, diff(district$Cases))
      return(district) }) %>% bind_rows
```


# Comparison with the data from Health Map.

First read in and clean up the data from Health Map. Since these data
are at national level, we will also aggregate the WHO data at country
level. HealthMap collects and curates data on the cumulative number
of cases (C) and deaths (D) stratified by status (suspected, SC/SD, or
confirmed CC/CD). For data from the WHO, the case status could be
confirmed, probable or suspected. The final clinical outcome (alive/dead)
for each case is also recorded. In comparing the two data sets, we sum
across all four categories in Healthmap and derive incidence data from
cumulative data.

```{r, echo = FALSE}
species   <- "Humans"
disease   <- "Ebola"
case.type <- "SCC"
healthmap <- "data/CaseCounts/raw/HealthMap_Ebola_GNE_WHO.csv" %>%
               read.csv(stringsAsFactors = FALSE) %>%
               dplyr::filter(species == species,
                             disease == disease,
                             case.type == case.type,
                             Country %in% unique(WHO_incidence$Country) )

healthmap_bycountry <- split(healthmap, healthmap$Country) 

healthmap_weekly    <- healthmap_bycountry %>%
                       lapply(function(case.count){
                               location <- case.count$Country[1]
                               case.count %<>%
                                  incidence.from.DS1(species, disease,
                                                   case.type,
                                                   location,
                                                   merge_rule = "median") %<>%
                                 daily.to.weekly }) %>%
                        dplyr::bind_rows(.id = "Country")

WHO_bycountry <- WHO_bydistricts %>%
                  dplyr::group_by(Country, Date) %>% 
                  dplyr::summarise(count = n()) %>%
                  dplyr::rename(incid = count)



WHO_weekly <- split(WHO_bycountry, WHO_bycountry$Country) %>%
              lapply(function(df){
                      df      %>%
                      ungroup %>%
                      select(Date, incid) %>%
                      daily.to.weekly}) %>%
                dplyr::bind_rows(.id = "Country")    
WHO_weekly$Date       %<>% as.Date
healthmap_weekly$Date %<>% as.Date
list( WHO = WHO_weekly,
      HealthMap = healthmap_weekly[, c("Country", "Date", "incid")]) %>%
    dplyr::bind_rows(.id = "Source") %>%
    ggplot(aes(Date, incid, color = Source)) +
    geom_point() +
    facet_grid(Country ~.) +
    scale_x_date(date_labels="%d/%m/%y",date_breaks = "3 weeks") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

HealthMap numbers (after data clean-up) appear to be much bigger than
the numbers from WHO, particularly in the middle of the
epidemic. 


# Estimating Reproduction number from WHO and Healthmap Data

```{r}
mean_SI     <- 14.2
CV_SI       <- 9.6 / 14.2
SItrunc     <- 40
SI_Distr    <- sapply(0:SItrunc, function(e) DiscrSI(e, mean_SI, mean_SI * CV_SI))
SI_Distr    <- SI_Distr / sum(SI_Distr)
time_window <- 7 * 7
healthmap_R <- healthmap_bycountry %>%
               lapply(function(case.count){
                        location <- case.count$Country[1]
                        case.count %<>%
                        incidence.from.DS1(species, disease,
                                           case.type,
                                           location,
                                           merge_rule = "median")
                        start     <- 1:(length(case.count$Date) - time_window)
                        end       <- start + time_window
                        end.dates <- case.count$Date[end] 
                        res       <- EstimateR(case.count$incid,
                                               T.Start  = start ,
                                               T.End    = end,
                                               method   = "NonParametricSI",
                                               SI.Distr = SI_Distr,
                                               plot     = FALSE ,
                                               CV.Posterior = 1 ,
                                               Mean.Prior   = 1 ,
                                               Std.Prior    = 0.5)
                        res$R %<>% cbind(Date = end.dates)
                        return(res$R)}) %>%
              bind_rows(.id = "Country")

WHO_R <- WHO_bycountry    %>%
         split(.$Country) %>%
         lapply(function(case.count){
                  location  <- case.count$Country[1]
                  start     <- 1:(length(case.count$Date) - time_window)
                  end       <- start + time_window
                  end.dates <- case.count$Date[end] 
                  res       <- EstimateR(case.count$incid,
                                         T.Start  = start ,
                                         T.End    = end,
                                         method   = "NonParametricSI",
                                         SI.Distr = SI_Distr,
                                         plot     = FALSE ,
                                         CV.Posterior = 1 ,
                                         Mean.Prior   = 1 ,
                                         Std.Prior    = 0.5)
                  res$R %<>% cbind(Date = end.dates)
                  return(res$R)}) %>%
           bind_rows(.id = "Country")


list( WHO = WHO_R, HealthMap = healthmap_R) %>%
    dplyr::bind_rows(.id = "Source") %>%
    ggplot(aes(Date, `Mean(R)`, color = Source)) +
    geom_line() +
    facet_grid(Country ~.) +
    scale_x_date(date_labels="%d/%m/%y",date_breaks = "3 weeks") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Projection using WHO data
## Projection within a country 
```{r}
WHO_guinea <- WHO_bydistricts %>%
              filter(Country == "Guinea") %>%
              select(-c(Country, Cases))  %>%
              na.omit


```
Guinea is divided into 8 regions whereas the incidence data is
recorded at a finer scale (prefectures). The relation between
prefectures and regions can be scraped from Wikipedia.

```{r}
prefectures <- "https://en.wikipedia.org/wiki/Prefectures_of_Guinea" %>%
               rvest::html(.) %>%
               rvest::html_nodes("table") %>%
               `[[`(2) %>%
               rvest::html_table(.)

prefectures$Region <- NA
tmp <- which(is.na(prefectures[, 1]))
for(i in 1:(length(tmp) - 1)){
    prefectures$Region[tmp[i]:(tmp[i+1] - 1)] <- prefectures$Name[tmp[i]]
}

prefectures <- prefectures[-tmp,  c("Name", "Region")]
prefectures %<>% apply(c(1, 2), function(n){
                                   n %<>%
                                   chartr("áéó", "aeo", .)   %<>%
                                   gsub("Region de ", "", .) %<>%    
                                   toupper
                                   return(n)}) %>% data.frame

```

We will add a column for the Region so that we can later use this for
analysis.

```{r}
WHO_guinea$CL_DistrictRes %<>% plyr::mapvalues(from = c("N'ZEREKORE", "KISSIDOUGO"),                                                 to  = c("NZEREKORE", "KISSIDOUGOU"))
WHO_guinea %<>%
    dplyr::left_join(prefectures, by = c("CL_DistrictRes" = "Name"))

```
For now, we will ignore the  variation in reproduction number across
regions and use the same estimate for all regions.


```{r}

guinea_byregion <- WHO_guinea %>%
                     select(-CL_DistrictRes) %>%
                     group_by(Region, Date)  %>% 
                     summarise(count = n())  %>%
                     rename(incid = count)
guinea_regions  <- unique(WHO_guinea$Region)

tmp <- tidyr::spread(guinea_byregion, Region, incid)

apply(tmp, 2, function(col) sum(!is.na(col)))
```
We will proceed as we did with HealthMap data - split the data set into training and
validation sets, set up the parameters and press play.

```{r}
t.proj      <- 133L
n.sim       <- 1000L    # Number of simulations to run
n.dates.sim <- 35L      # The time period over which projection will be made.

guinea_R          <- filter(WHO_R, Country == "Guinea")
guinea_training   <- guinea_bydistrict[1:t.proj, ]
guinea_validation <- guinea_bydistrict[(1 + t.proj):nrow(guinea_bydistrict), ]

cutoff <- which(guinea_R$Date %in%  guinea_bydistrict[t.proj, "Date"])
shape  <- guinea_R[cutoff, "Mean(R)"]^2 / guinea_R[cutoff, "Std(R)"]^2
scale  <- guinea_R[cutoff, "Std(R)"]^2 /  guinea_R[cutoff, "Mean(R)"]
restim <- rgamma(n.sim, shape = shape, scale = scale))
```
# Population flow matrix

```{r}
pow_N_from <- 1
pow_N_to   <- 1
pow_dist   <- 2
K          <- 1

adm1_centroids <- "data/Geography/GravityModel/raw/adm1_centroids_fixed.tsv" %>%
                   read.csv(stringsAsFactors = FALSE,
                            sep = "\t",
                            header = TRUE) %>%
                    filter(ADM0 == "Guinea")

adm1_centroids$ADM1       %<>%
  chartr("áéó", "aeo", .) %<>%
  toupper
 
flow.matrix  <- flow_matrix(longitude   = adm1_centroids[, "Centroid_Lon"],
                            latitude    = adm1_centroids[, "Centroid_Lat"],
                            population  = adm1_centroids[, "Pop"],
                            place.names = adm1_centroids[, "ADM1"],
                            model = "gravity", K = K,
                            pow_N_from = pow_N_from,
                            pow_N_to   = pow_N_to,
                            pow_dist   = pow_dist)


## Relative risk
relative.risk <- flow.matrix / rowSums(flow.matrix, na.rm=TRUE)

p.stay     <- 0.99 
p.movement <- probability_movement(relative.risk, p.stay)
```
