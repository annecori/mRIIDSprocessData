---
output: 
pdf_document:
citation_package: natbib
keep_tex: true
fig_caption: true
latex_engine: pdflatex
title: Relative Risk of Importation 
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  cases: 22_may_2018.csv
  risk: !r c("flow_from_mbandaka_1.csv", "flow_from_Ã‰quateur_1.csv")
  pstay: 0.95
  sim: 10000
  simean: 14
  sisd: 1
---
```{r setup, eval = TRUE, echo = FALSE}
library(dplyr)
library(magrittr)
library(stringr)
library(ggplot2)
```

This analysis uses a daily incidence time series to estimate the
overall infectivity at a given time. The relative risk profiles
estimated in a previous step of the analysis pipeline are then
weighted by the infectivity.

## Ebola params
```{r}
incid <- here::here("data/CaseCounts/drc",
                    params$cases) %>%
    readr::read_csv()
```
BIKORO and Iboko are in Equateur province while Wangata is in Mbandaka
province.

```{r}
incid$eq <- incid$Bikoro + incid$Iboko
incid$mb <- incid$Wangata
```
Serial interval estimation over however many days worth of data we
have at this point.

```{r}
si <- EpiEstim::DiscrSI(k = seq_len(nrow(incid)),
                        mu = params$simean,
                        sigma  = params$sisd) %>% round(3)
eq_infectivity <- EpiEstim::OverallInfectivity(incid$eq, si)
mb_infectivity <- EpiEstim::OverallInfectivity(incid$mb, si)

```
Read in the relative risk profiles

```{r relrisk, eval = TRUE}

rel_risk <- purrr::map(params$risk, function(x) {
    here::here("output", x) %>%
    readr::read_csv() 
})

```
# Normalise weights

```{r}
day <- nrow(incid)
weights <- c(mb_infectivity[day], eq_infectivity[day])
normalised <- weights / sum(weights)
```
## Risk profile weighted by infectivity

```{r}
wtd_rel_risk <- (normalised[1]  * rel_risk[[1]]$relative_flow) +
    (normalised[2] * rel_risk[[2]]$relative_flow)
##wtd_rel_risk <- round(wtd_rel_risk, 5)
wtd_risk_profile <- data.frame(flow_to = rel_risk[[1]]$flow_to,
                               wtd_rel_risk = wtd_rel_risk,
                               adm0 = rel_risk[[1]]$ADM0,
                               adm1 = rel_risk[[1]]$ADM1) 
```

```{r}
outfile <- purrr::map_chr(params$risk,
                          function(x) stringr::str_replace(x ,
                                                           ".csv",
                                                           "")) %>%
    paste(collapse = "_")

outfile <- here::here("output", paste0(outfile, ".csv"))
readr::write_csv(x = wtd_risk_profile, path = outfile)
```

## Number of cases that move out

```{r export, eval = FALSE}
weekly$exported <- (1 - params$pstay) * weekly$incid
```
## Relative Risk 

```{r binning, eval = FALSE}
pmatrix <- data.frame(matrix(rel_risk$relative_flow, nrow = 1))

binned <- split(weekly, weekly$date) %>%
    purrr::map_dfr(function(w){
    tmp <- disaggregate(w$exported, pmatrix = pmatrix, sim = params$sim)
    colnames(tmp) <- rel_risk$flow_to
    disaggregate_distr(tmp)
    }, .id = "date")
```

## Results

```{r}
#knitr::kable(binned)
```
