---
output: 
  pdf_document:
    toc: true
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
title: Analysis of WHO Ebola data
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
abstract: 
keywords: 
date: "Y"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
bibliography: 
biblio-style: apsr
endnote: no
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, echo=FALSE, warning=FALSE, message=FALSE)
```

```{r setup, echo = FALSE}
library(magrittr)
library(ggplot2)
library(dplyr)
library(EpiEstim)
devtools::load_all()

```
# Data clean-up
The current data set has three possible values for the epidemiological
case definition - confirmed, probable and suspected.
Epidemiological case definition of probable and suspected cases
differed across countries while confirmed cases were the ones
confirmed through lab report. For the purpose of the current analysis,
one approach could be to lump all of them together. The inferred date of
onset (rather than the date reported) is used for estimation.
The columns we use are : Country, EpiCaseDef (probably),
DateOnsetInferred and CL_DistrictRes. 


```{r rawdata}
WHO_raw <- read.csv("data/CaseCounts/who/rstb20160308supp1.csv",
                    colClasses = c(Country = "factor",
                                   EpiCaseDef = "character",
                                   DateOnsetInferred = "Date",
                                   CL_DistrictRes = "factor")) %>%
           select(Country, EpiCaseDef,
                  DateOnsetInferred,CL_DistrictRes) %>%
           na.omit

WHO_raw$CL_DistrictRes %<>% gsub(' ', '', .)  %<>% factor



```


## Grouping by districts and interpolating missing data
For each district in a country, add the number of records for each
date to get incidence count.

```{r bydistricts}

WHO_bydistricts <- WHO_raw %>% 
                   group_by(Country, CL_DistrictRes,
                                   DateOnsetInferred) %>%
                   summarise(incid = n())

```

Within each district, if there is a date on which no cases are
recorded, we assume that there were no cases on that date and add this
to the record. At the end of this step, the incidence time series for
each district should be a daily time series.

```{r bycountry}

WHO_bydistricts %<>%
    split(.$CL_DistrictRes) %<>%
    lapply(add_0incid) %<>%
    bind_rows


WHO_bydistricts %<>% rename(Date = DateOnsetInferred)

WHO_bycountry <- WHO_bydistricts %>%
                  group_by(Country,Date) %>%
                  summarise(incid = sum(incid)) 


ggplot(WHO_bydistricts, aes(Date, incid)) +
    geom_point() +
    facet_wrap(~CL_DistrictRes) +
    theme_minimal() +
    ggtitle("Incidence in each district") +
    xlab("") + theme(axis.text.x = element_text(angle = 45, vjust = 0.2))

ggplot(WHO_bycountry, aes(Date, incid)) +
    geom_point() +
    facet_wrap(~Country) +
    theme_minimal() +
    ggtitle("Incidence in each country") +
    xlab("") + theme(axis.text.x = element_text(angle = 45, vjust = 0.2))

```

# Comparison with the data from Health Map.

First read in and clean up the data from Health Map. Since these data
are at national level, we will also aggregate the WHO data at country
level. HealthMap collects and curates data on the cumulative number
of cases (C) and deaths (D) stratified by status (suspected, SC/SD, or
confirmed CC/CD). For data from the WHO, the case status could be
confirmed, probable or suspected. The final clinical outcome (alive/dead)
for each case is also recorded. In comparing the two data sets, we sum
across all four categories in Healthmap and derive incidence data from
cumulative data.

```{r hmread, echo = FALSE}
species   <- "Humans"
disease   <- "Ebola"
case.type <- "SCC"
healthmap <- "data/CaseCounts/raw/HealthMap_Ebola_GNE_WHO.csv" %>%
               read.csv(stringsAsFactors = FALSE) %>%
               filter(species == species,
                             disease == disease,
                             case.type == case.type,
                             Country %in% unique(WHO_raw$Country) )

healthmap_bycountry <- split(healthmap, healthmap$Country) 

healthmap_weekly    <- healthmap_bycountry %>%
                       lapply(function(case.count){
                               location <- case.count$Country[1]
                               case.count %<>%
                                  incidence.from.DS1(species, disease,
                                                   case.type,
                                                   location,
                                                   merge_rule = "median") %<>%
                                 daily.to.weekly }) %>%
                        bind_rows(.id = "Country")


WHO_weekly <- split(WHO_bycountry, WHO_bycountry$Country) %>%
              lapply(function(df){
                      df      %>%
                      ungroup %>%
                      select(Date, incid) %>%
                      daily.to.weekly}) %>%
                bind_rows(.id = "Country")    
WHO_weekly$Date       %<>% as.Date
healthmap_weekly$Date %<>% as.Date

list( WHO = WHO_weekly,
      HealthMap = healthmap_weekly[, c("Country", "Date", "incid")]) %>%
    bind_rows(.id = "Source") %>%
    ggplot(aes(Date, incid, color = Source)) +
    geom_point() +
    facet_grid(Country ~.) +
    scale_x_date(date_labels="%d/%m/%y",date_breaks = "3 weeks") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

# Parameters for Ebola

Culled from literature.

```{r ebola_params}
mean_SI     <- 14.2
CV_SI       <- 9.6 / 14.2
SItrunc     <- 40
SI_Distr    <- sapply(0:SItrunc, function(e) DiscrSI(e, mean_SI, mean_SI * CV_SI))
SI_Distr    <- SI_Distr / sum(SI_Distr)
time_window <- 7 * 7
```


# Estimating Reproduction number from WHO and Healthmap Data

```{r who_vs_hm}

healthmap_R <- healthmap_bycountry %>%
               lapply(function(case.count){
                        location <- case.count$Country[1]
                        case.count %<>%
                        incidence.from.DS1(species, disease,
                                           case.type,
                                           location,
                                           merge_rule = "median")
                        start     <- 1:(length(case.count$Date) - time_window)
                        end       <- start + time_window
                        end.dates <- case.count$Date[end] 
                        res       <- EstimateR(case.count$incid,
                                               T.Start  = start ,
                                               T.End    = end,
                                               method   = "NonParametricSI",
                                               SI.Distr = SI_Distr,
                                               plot     = FALSE ,
                                               CV.Posterior = 1 ,
                                               Mean.Prior   = 1 ,
                                               Std.Prior    = 0.5)
                        res$R %<>% cbind(Date = end.dates)
                        return(res$R)}) %>%
              bind_rows(.id = "Country")

WHO_R <- WHO_bycountry    %>%
         split(.$Country) %>%
         lapply(function(case.count){
                  location  <- case.count$Country[1]
                  start     <- 1:(length(case.count$Date) - time_window)
                  end       <- start + time_window
                  end.dates <- case.count$Date[end] 
                  res       <- EstimateR(case.count$incid,
                                         T.Start  = start ,
                                         T.End    = end,
                                         method   = "NonParametricSI",
                                         SI.Distr = SI_Distr,
                                         plot     = FALSE ,
                                         CV.Posterior = 1 ,
                                         Mean.Prior   = 1 ,
                                         Std.Prior    = 0.5)
                  res$R %<>% cbind(Date = end.dates)
                  return(res$R)}) %>%
           bind_rows(.id = "Country")


list( WHO = WHO_R, HealthMap = healthmap_R) %>%
    bind_rows(.id = "Source") %>%
    ggplot(aes(Date, `Mean(R)`, color = Source)) +
    geom_line() +
    facet_grid(Country ~.) +
    scale_x_date(date_labels="%d/%m/%y",date_breaks = "3 weeks") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

The graphs show that the estimates from the two different sources
closely track each other. Here's another way to visualise this.

```{r}

HM_vs_WHO <- inner_join(WHO_R, healthmap_R,
                        by = c("Date", "Country")) %>%
              select(Country, Date, `Mean(R).x`,  `Mean(R).y`) %>%
              rename("WHO" = `Mean(R).x`,
                     "HealthMap" = `Mean(R).y`)

ggplot(HM_vs_WHO, aes(HealthMap, WHO)) +
    geom_point() +
    facet_wrap(~Country, nrow = 3) +
    xlab("R estimated from HealthMap data") +
    ylab("R estimated from WHO data") +
    geom_abline(slope = 1)

```

As the above graph indicates, estimates of the reproduction number
from HealthMap and WHO data are highly correlated (correlation
coefficient = 0.76, 95% CI = (0.74, 0.78)).

```{r}
cor.test(HM_vs_WHO$WHO, HM_vs_WHO$HealthMap)
```

# Projection using WHO data

## Projection within Sierra Leone

```{r child = 'WHO-data-analysis-Sierra.Rmd'}
```

## Projection within Liberia

```{r child = 'WHO-data-analysis-Liberia.Rmd'}
```

## Projection within Guinea

```{r child = 'WHO-data-analysis-Guinea.Rmd'}
```
