---
output: 
pdf_document:
citation_package: natbib
keep_tex: true
fig_caption: true
latex_engine: pdflatex
title: Relative Risk of Importation 
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  cases: 21-May-2018.csv
  risk: !r c("flow_from_mbandaka_1_1_1.csv","flow_from_équateur_1_1_1.csv")
  pmove: !r c(mb = "pmovement_from_mbandaka_1_1_1.csv", eq = "pmovement_from_équateur_1_1_1.csv")
  pstay: 0.95
  sim: 10000
  simean: 15.3
  sisd: 9.1
  R: 1.03
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width = 12,
                      fig.height = 6,
                      echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "figures/")

```
```{r setup, eval = TRUE, echo = FALSE}
library(dplyr)
library(magrittr)
library(stringr)
library(ggplot2)
library(ggthemes)
```

This analysis uses a daily incidence time series to estimate the
overall infectivity at a given time. The relative risk profiles
estimated in a previous step of the analysis pipeline are then
weighted by the infectivity.

## Ebola params
```{r}
incid <- here::here("data/CaseCounts/drc",
                    params$cases) %>%
    readr::read_csv()
```
BIKORO and Iboko are in Equateur province while Wangata is in Mbandaka
province.

```{r}
incid$eq <- incid$Bikoro + incid$Iboko
incid$mb <- incid$Wangata
```
Serial interval estimation over however many days worth of data we
have at this point.

```{r}
si <- EpiEstim::DiscrSI(k = 0:nrow(incid),
                        mu = params$simean,
                        sigma  = params$sisd) %>% round(3)
eq_infectivity <- EpiEstim::overall_infectivity(incid$eq, si)
mb_infectivity <- EpiEstim::overall_infectivity(incid$mb, si)

```



```{r eqinf}
p1 <- ggplot(NULL, aes(factor(seq_len(length(eq_infectivity))),
                       eq_infectivity)) +
    geom_col() +
    ylab("Infectivity") +
    xlab("Day") +
    ylim(0, 1) +
    theme_tufte() 
```

```{r mbinf}
p2 <- ggplot(NULL, aes(factor(seq_len(length(mb_infectivity))),
                       mb_infectivity)) +
    geom_col() +
    ylab("Infectivity") +
    xlab("Day") +
    ylim(0, 1) +
    theme_tufte() 
```
```{r together}
ggpubr::ggarrange(p1, p2, nrow = 1, ncol = 2)
```

Read in the relative risk profiles

```{r relrisk, eval = TRUE}

rel_risk <- purrr::map(params$risk, function(x) {
    here::here("output", x) %>%
    readr::read_csv() 
})

```
# Normalise weights

```{r}
day <- nrow(incid)
weights <- c(mb_infectivity[day], eq_infectivity[day])
normalised <- weights / sum(weights)
```
## Risk profile weighted by infectivity

```{r}
wtd_rel_risk <- (normalised[1]  * rel_risk[[1]]$relative_flow) +
    (normalised[2] * rel_risk[[2]]$relative_flow)


wtd_risk_profile <- data.frame(orig_name = rel_risk[[1]]$district,
                               flow_to = rel_risk[[1]]$flow_to,
                               wtd_rel_risk = wtd_rel_risk,
                               adm0 = rel_risk[[1]]$ADM0)
```

```{r}
outfile <- purrr::map_chr(params$risk,
                          function(x) stringr::str_replace(x ,
                                                           ".csv",
                                                           "")) %>%
    paste(collapse = "_")

outfile <- here::here("output", paste0(outfile, ".csv"))
readr::write_csv(x = wtd_risk_profile, path = outfile)
```

## Number of cases that move out
Read in the probability of moving out.

```{r export, eval = TRUE}
pmovement <- purrr::map(params$pmove, function(x) {
    here::here("output", x) %>%
    readr::read_csv() 
})

```

Mean for the Poisson process.

```{r}
lambda <- function(ws, I, r_t) {
    (ws  %*% I) * r_t
}    

mean_eq <- lambda(r_t = params$R, 
                  I = matrix(c(0, incid$eq), ncol = 1),
                  ws = rev(si))

mean_mb <- lambda(r_t = params$R, 
                  I = matrix(c(0, incid$mb), ncol = 1),
                  ws = rev(si))

```
## Expected number of infected people
```{r}
pmovement$eq$expected <- pmovement$eq$pij * mean_eq
pmovement$mb$expected <- pmovement$mb$pij * mean_mb
readr::write_csv(pmovement$eq, path = "from_eq.csv")
readr::write_csv(pmovement$mb, path = "from_mb.csv")
```

Finally join and add.

```{r}
from_both <- left_join(pmovement$eq,
                      pmovement$mb,
                      by = c("flow_to" = "flow_to"))

from_both$total <- from_both$expected.x + from_both$expected.y

here::here("output",
           "absolute_risk.csv") %>% readr::write_csv(x = from_both,
                                                     path = .)
```

## Relative Risk 

```{r binning, eval = FALSE}
pmatrix <- data.frame(matrix(rel_risk$relative_flow, nrow = 1))

binned <- split(weekly, weekly$date) %>%
    purrr::map_dfr(function(w){
    tmp <- disaggregate(w$exported, pmatrix = pmatrix, sim = params$sim)
    colnames(tmp) <- rel_risk$flow_to
    disaggregate_distr(tmp)
    }, .id = "date")
```



## Results

```{r}
#knitr::kable(binned)
```
