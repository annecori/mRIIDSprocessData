---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
title: 
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
abstract: 
keywords: 
date: "`r Sys.Date()`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
bibliography: 
biblio-style: apsr
endnote: no
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width = 12, fig.height = 6, echo = FALSE, warning = FALSE, message = FALSE, fig.path = "figures/")
```

```{r setup}
library(magrittr)
library(ggplot2)
library(ggthemes)
library(scales)
library(dplyr)
library(purrr)
devtools::load_all()
```


```{r ds1_params}

species <- "Humans"
disease <- "Ebola"
case.type <- "scc"
```

# Data clean-up

Visualising the raw data.



```{r}

promed_drc <- here::here("data/CaseCounts/raw",
                         "Ebola outbreak DRC 2014 curated data.xlsx") %>%
    readxl::read_excel() %>%
    janitor::clean_names() %>%
    filter(species == species & disease == disease)

```
Country is reported as both  "DR Congo"  and "Democratic Republic of
the Congo". So make country name consistent.

```{r}
promed_drc$country <- stringr::str_replace_all(promed_drc$country,
                                               "Democratic Republic of the Congo",
                                               "DRC")

promed_drc$country <- stringr::str_replace_all(promed_drc$country,
                                               "DR Congo",
                                               "DRC")

```
Rename columns as per the previous feeds received.

```{r}
promed_drc <- rename(promed_drc,
                     healthmap_alert_id = hm_alert_id,
                     sc = new_sc,
                     sd = new_sd,
                     cc = new_cc,
                     cd = new_cd)
```

Split date and time. We are not going to use time anyway.

```{r}
promed_drc <- tidyr::separate(promed_drc,
                              col = issue_date,
                              into = c("issue_date", "timestamp"),
                              sep = " ",
                              remove = TRUE)
```

```{r hm_rawviz, eval = TRUE}
promed_drc_tall <- promed_drc %>%
    select(`issue_date`, `sc`, `sd`,
           `cc`, `cd`, `country`) %>%
  tidyr::gather(
    case_type,
    count, -c(issue_date, country)
  )

promed_drc_tall$issue_date <- lubridate::ymd(promed_drc_tall$issue_date)
p <- promed_drc_tall %>%
  ggplot(aes(issue_date, count, color = case_type)) +
  geom_point() +
  xlab("") + ylab("New Case Count")
p <- p + geom_rangeframe() + theme_bw()
p <- p + theme(axis.text.x = element_text(angle = 80, hjust = 1))
p <- p + theme(legend.title = element_blank())
p <- p + xlab("")
p <- p + scale_x_date(date_labels = "%b %Y")
p
```
The data clean-up consists of the following steps:
1. Extract the cumulative case count as a sum of suspected and
confirmed cases.
2. Merge duplicate alerts.
3. Remove outliers and interpolate missing data.
4. Determine the incidence count from the cumulative case count.


```{r}


cols.to.keep <- c(
  "location", "country", "disease", "species",
  "healthmap_alert_id", "headline", "url",
  "alert_tag", "feed_name", "lon", "lat"
)
## These are columns we generate ourselves later on
cols.to.keep <- c(cols.to.keep, "date", "cases")

## Record all intermediate steps
record <- list()

drc_case_count <- update_cases_column(promed_drc, case.type)
record <- c(record, update_case_column = list(select(drc_case_count, date, cases)))
no_duplicates <- merge_duplicates(drc_case_count, cols.to.keep)
record <- c(record, merge_duplicates = list(select(no_duplicates, date, cases)))

no_duplicates <- arrange(no_duplicates, date)
```
This is the number of new cases on a given day rather than the number
of cumulative cases upto that point. Get cumulative case count -
that's what we will interpolate.


```{r}
cum.incidence <- filter(no_duplicates, !is.na(cases)) %>%
    select(date, cases)
cum.incidence$cases <- cumsum(cum.incidence$cases)
first.row <- cum.incidence[1, ]
first.row$date <- first.row$date - 1
first.row$cases <- 0
cum.incidence <- rbind(first.row, cum.incidence)
cum.incidence <- interpolate_missing_data(cum.incidence)
record <- c(record, interpolated = list(select(cum.incidence,
                                          date,
                                          cases = interpolated_cases)))
    
```


## Visualising Data Cleaning Steps

```{r}
cleanup_steps <- dplyr::bind_rows(record, .id = "step")
ggplot(cleanup_steps, aes(date, cases)) +
    facet_wrap(~step, nrow = 3, scale = "free_y") +
    xlim("2014-08-22", "2014-09-11") +
    geom_point() +
    theme_bw()

```

Get incidence now from cumulative incidence.

```{r}
cum.incidence$incid <- c(0, diff(cum.incidence$interpolated_cases))
```
