---
output: 
pdf_document:
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: Estimate relative risk profile
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  pow_dist : 1
  K : 1
  pow_N_from : 1
  pow_N_to : 1
  from : Ã©quateur
  tau: 1
  rho: 1
  alpha: -1
---

```{r setup, eval = TRUE}
library(dplyr)
library(stringr)
library(ggplot2)
devtools::load_all()
```

## Workflow

1. Compute the flow matrix using the parameters of the gravity model.
2. Compute the relative risk matrix using $p_{stay}$.
3. Extract the top 10 places most at risk from a given location
   (input).

```{r}
centroids <- outfile <- here::here("data/Geography/GravityModel/processed",
                                   "drc_neighbors_pops.csv") %>%
    readr::read_csv()


centroids <- mutate(centroids, district_clean = clean_names(district))

```


## Flow Matrix 
```{r flowmat, eval = TRUE}



flow_from_to <- flow_matrix(
  longitude = centroids$Centroid_Lon,
  latitude = centroids$Centroid_Lat,
  population = centroids$Pop,
  place_names = centroids$district_clean,
  model = "gravity_alt",
  tau = params$tau,
  rho = params$rho,
  alpha = params$alpha
)


## Relative Flow
relative_risk <- flow_from_to / rowSums(flow_from_to, na.rm = TRUE)
```

Probability that 1 person from params$from will move to j.
Note that there is no reason why flow from i to j should be smaller
than the population at i. Hence the "probability" here can be greater
than 1.

```{r}

source_pop <- filter(centroids, district_clean == params$from) %>%
    pull(Pop)
pij <- flow_from_to[params$from, ] / source_pop
pij_df <- tibble::rownames_to_column(data.frame(pij),
                                     var = "flow_to" )
pij_df$flow_from <- params$from
pij_df <- left_join(pij_df,
                    centroids,
                    by = c("flow_to" = "district_clean")) %>%
    select(flow_from, flow_to, pij, district)
here::here("output",
           paste0("pmovement_from_",
                  params$from,
                  "_",
                  params$pow_dist,
                  "_",
                  params$pow_N_from,
                  "_",
                  params$pow_N_to,
                  ".csv")) %>% readr::write_csv(x = pij_df,
                                                path = .)

```

Write it out in a clean format. The rownames will be the cleaned
district names.

```{r write, eval = TRUE}
rel_risk_df <- tibble::rownames_to_column(data.frame(relative_risk),
                                            var = "flow_from")
from_source <- filter(rel_risk_df,
                      flow_from == params$from) %>%
    tidyr::gather(flow_to, relative_flow, -flow_from) 

##    top_n(10)
##from_source$relative_flow <- round(from_source$relative_flow, 3)

idx <- which(from_source$flow_to == "louvakou.loubomo.")
from_source$flow_to[idx] <- "louvakou(loubomo)"

from_source <- left_join(from_source,
                         centroids,
                         by = c("flow_to" = "district_clean")) %>%
    select(flow_from, flow_to, district, ADM0, relative_flow)

here::here("output",
           paste0("flow_from_",
                  params$from,
                  "_",
                  params$pow_dist,
                  "_",
                  params$pow_N_from,
                  "_",
                  params$pow_N_to,
                  ".csv")) %>% readr::write_csv(x = from_source,
                                                path = .)
```


## Top 10 regions at risk

```{r}
arrange(from_source, desc(relative_flow)) %>%
    top_n(10) %>%
    knitr::kable()
```
