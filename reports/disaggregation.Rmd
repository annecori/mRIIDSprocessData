---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
title: 
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
abstract: 
keywords: 
date: "Y"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  pow_dist : 2
  t.proj : 500
  n.sim : 1000
  n.dates.sim : 49
  p.stay: 0.9
  ADM0: SIERRALEONE
---

```{r global_options, include=FALSE}

knitr::opts_chunk$set(
  fig.width = 12, fig.height = 6,
  echo = FALSE,
  warning = FALSE, message = FALSE,
  fig.path = "figures/"
)
```

```{r setup, eval = TRUE}

library(dplyr)
library(magrittr)
library(stringr)
library(ggplot2)
devtools::load_all()
```

## Unpack parameters

```{r pars_read, eval = TRUE}

pow_dist <- params$pow_dist
t.proj <- params$t.proj
n.sim <- params$n.sim
n.dates.sim <- params$n.dates.sim
p.stay <- params$p.stay
adm0 <- params$ADM0
```

## Model

We will assign the national case count to districts according to a
multinomial distribution with the probabilities derived from gravity
model or simply population density. 

First we read in the data that is required by both methods.

## Districts meta-data

```{r districts_coord, eval = TRUE}

centroids <- here::here(
  "data/Geography/GravityModel/processed",
  "all_centroids.csv"
) %>%
  readr::read_csv(.) %>%
  filter(ADM0 == adm0)
```

## Incidence data from HealthMap

```{r hm_data, eval = TRUE}

hm_wide <- here::here(
  "data/CaseCounts/processed",
  "HealthMap_Ebola_wide.csv"
) %>%
  readr::read_csv(.)
```  

We will work with weekly incidence counts. 

```{r hm_weekly, eval = TRUE}

hm_weekly <- daily.to.weekly(hm_wide)
```

## Incidence data from WHO

District-level data from WHO to compare our estimates with.


```{r who, eval = TRUE}
cols <- c("Date", centroids$CL_DistrictRes)
who_districts <- here::here(
  "data/CaseCounts/processed",
  "WHO_wide.csv"
) %>%
  readr::read_csv(.) %>%
  select(cols)


who_weekly <- daily.to.weekly(who_districts) %>%
  tidyr::gather(district, incid, -Date)

who_weekly$Date <- as.Date(who_weekly$Date)
```

## Method 1: Relative population density

Take the weekly incidence
count and distribute it to the districts in proportion to their
relative density.

```{r pop_density, eval = TRUE}

pop_density <- data.frame(
  district = centroids$CL_DistrictRes,
  rel_density = centroids$pop / sum(centroids$pop)
)
```

## Method 2: Relative risk based on gravity model


```{r pmovement, eval = TRUE}
flow_mat <- flow_matrix(
  longitude = centroids$lon,
  latitude = centroids$lat,
  population = centroids$pop,
  place_names = centroids$CL_DistrictRes,
  model = "gravity", K = K,
  pow_N_from = pow_N_from,
  pow_N_to = pow_N_to,
  pow_dist = pow_dist
)



rel_risk <- flow_mat / rowSums(flow_mat, na.rm = TRUE)
p_movement <- probability_movement(rel_risk, p_stay)
```

## Assign cases to districts

Best to do it when the number of cases is not too small.

```{r}

hm_large <- filter(hm_weekly, `Sierra Leone` > 2)
sl_large <- select(hm_large, c(Date, `Sierra Leone`))
district_weekly <- split(sl_large, sl_large$Date) %>%
  lapply(function(df) {
    mat <- disaggregate(
      total = df$`Sierra Leone`,
      prob = pop_density$rel_density
    )
    distr <- t(apply(
      mat, 1, quantile,
      probs = c(0.025, 0.5, 0.975)
    ))
    rownames(distr) <- pop_density$district
    distr <- data.frame(distr)
    distr <- tibble::rownames_to_column(distr, var = "district")
    distr
  }) %>% bind_rows(.id = "Date")
```

## Compare with data from WHO

Put them together and plot.

```{r}
comparison <- left_join(who_weekly, district_weekly) %>% na.omit()
comparison$Date <- as.Date(comparison$Date)

p <- ggplot(comparison, aes(Date,incid)) + geom_point(size = 0.5,
                                                      col = "blue") 
p <- p + facet_wrap(~district, scales = "free_y")
p <- p + geom_line(aes(y = `X50.`))
p <- p + geom_ribbon(aes(ymin = `X2.5.`,
                         ymax = `X97.5.`,
                         group = 1), alpha = 0.5)
p <- p + theme_classic()
p

```
